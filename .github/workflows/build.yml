name: Build Switchy — macOS

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  release:
    types: [published]

env:
  OBS_VERSION: "30.2.2"
  QT_VERSION: "6.7.2"

permissions:
  contents: write

jobs:
  # ── Apple Silicon (arm64) ─────────────────────────────────────────────────
  build-arm64:
    name: macOS Apple Silicon (arm64)
    runs-on: macos-14   # M1 runner
    steps:
      - uses: actions/checkout@v4

      - name: Install build tools
        run: brew install ninja cmake

      - name: Install Qt6 (cached)
        uses: jurplel/install-qt-action@v4
        with:
          version: ${{ env.QT_VERSION }}
          host: mac
          target: desktop
          arch: clang_64
          cache: true

      - name: Fetch OBS headers (sparse — no full build needed)
        run: |
          git clone --depth 1 --filter=blob:none --sparse \
            --branch ${{ env.OBS_VERSION }} \
            https://github.com/obsproject/obs-studio.git /tmp/obs-studio
          cd /tmp/obs-studio
          git sparse-checkout set libobs UI/obs-frontend-api

      - name: Configure Switchy
        run: |
          cmake -B build -S . -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DOBS_SOURCE_DIR=/tmp/obs-studio \
            -DCMAKE_PREFIX_PATH="${Qt6_DIR}"

      - name: Build
        run: cmake --build build -v

      - name: Create .pkg installer
        run: |
          PLUGIN="$RUNNER_TEMP/stage/Library/Application Support/obs-studio/plugins/obs-auto-cam-switcher"
          mkdir -p "$PLUGIN/bin" "$PLUGIN/data"
          find build -name "*.dylib" -exec cp {} "$PLUGIN/bin/" \;
          cp -r data/. "$PLUGIN/data/"
          pkgbuild \
            --root "$RUNNER_TEMP/stage" \
            --identifier com.switchy.obs-auto-cam-switcher \
            --version 1.0.0 \
            --install-location / \
            Switchy-1.0.0-macos-arm64.pkg

      - name: Upload .pkg artifact
        uses: actions/upload-artifact@v4
        with:
          name: Switchy-macos-arm64
          path: Switchy-1.0.0-macos-arm64.pkg

  # ── Attach .pkg to GitHub Release ─────────────────────────────────────────
  release-artifacts:
    name: Attach to Release
    runs-on: ubuntu-latest
    needs: build-arm64
    if: github.event_name == 'release'
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: Switchy-macos-arm64
          path: installers
      - name: List installers
        run: find installers -name "*.pkg" | sort
      - uses: softprops/action-gh-release@v2
        with:
          files: installers/*.pkg
