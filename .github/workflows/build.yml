name: Build Switchy — macOS

on:
  push:
    branches: [master, main]
  pull_request:
    branches: [master, main]
  release:
    types: [published]

env:
  OBS_VERSION: "30.2.2"
  OBS_SRC: /tmp/obs-studio
  OBS_BLD: /tmp/obs-build

jobs:
  # ── Shared prep: clone OBS + configure (generates obs-config.h) ───────────
  # Run twice (once per arch runner) — macOS-14 is arm64, macOS-12 is x86_64

  # ── arm64 (Apple Silicon M1/M2/M3) ───────────────────────────────────────
  build-arm64:
    name: macOS Apple Silicon (arm64)
    runs-on: macos-14
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt6
        run: brew install qt@6

      - name: Clone OBS source (shallow)
        run: |
          git clone --depth 1 --branch ${{ env.OBS_VERSION }} \
            https://github.com/obsproject/obs-studio.git ${{ env.OBS_SRC }}

      - name: Configure OBS (generates obs-config.h, no build)
        run: |
          cmake -S ${{ env.OBS_SRC }} -B ${{ env.OBS_BLD }} \
            -DENABLE_PLUGINS=OFF \
            -DENABLE_UI=OFF \
            -DENABLE_SCRIPTING=OFF \
            -DBUILD_BROWSER=OFF \
            -DENABLE_WEBSOCKET=OFF 2>&1 | tail -5 || true
          echo "--- obs-config.h location ---"
          find ${{ env.OBS_BLD }} -name "obs-config.h" 2>/dev/null || echo "not found"

      - name: Build Switchy (arm64)
        run: |
          cmake -B build -S . -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DOBS_SOURCE_DIR=${{ env.OBS_SRC }} \
            -DOBS_BUILD_DIR=${{ env.OBS_BLD }} \
            -DCMAKE_PREFIX_PATH="$(brew --prefix qt@6)"
          cmake --build build
          echo "--- Built libraries ---"
          find build -name "*.dylib" | head -5

      - name: Create .pkg installer (arm64)
        run: |
          PLUGIN="$RUNNER_TEMP/stage/Library/Application Support/obs-studio/plugins/obs-auto-cam-switcher"
          mkdir -p "$PLUGIN/bin" "$PLUGIN/data"
          find build -name "*.dylib" -exec cp {} "$PLUGIN/bin/" \;
          cp -r data/. "$PLUGIN/data/"
          pkgbuild \
            --root "$RUNNER_TEMP/stage" \
            --identifier com.switchy.obs-auto-cam-switcher \
            --version 1.0.0 \
            --install-location / \
            Switchy-1.0.0-macos-arm64.pkg
          echo "✅ pkg created"

      - name: Upload arm64 .pkg
        uses: actions/upload-artifact@v4
        with:
          name: Switchy-macos-arm64
          path: Switchy-1.0.0-macos-arm64.pkg

  # ── x86_64 (Intel) — used to make the Universal slice ────────────────────
  build-x86_64:
    name: macOS Intel (x86_64)
    runs-on: macos-12          # macos-12 = Intel runner (macos-13 deprecated free tier)
    steps:
      - uses: actions/checkout@v4

      - name: Install Qt6
        run: brew install qt@6

      - name: Clone OBS source (shallow)
        run: |
          git clone --depth 1 --branch ${{ env.OBS_VERSION }} \
            https://github.com/obsproject/obs-studio.git ${{ env.OBS_SRC }}

      - name: Configure OBS (generates obs-config.h)
        run: |
          cmake -S ${{ env.OBS_SRC }} -B ${{ env.OBS_BLD }} \
            -DENABLE_PLUGINS=OFF -DENABLE_UI=OFF \
            -DENABLE_SCRIPTING=OFF -DBUILD_BROWSER=OFF \
            -DENABLE_WEBSOCKET=OFF 2>&1 | tail -5 || true
          find ${{ env.OBS_BLD }} -name "obs-config.h" 2>/dev/null || echo "not found"

      - name: Build Switchy (x86_64)
        run: |
          cmake -B build -S . -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=x86_64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DOBS_SOURCE_DIR=${{ env.OBS_SRC }} \
            -DOBS_BUILD_DIR=${{ env.OBS_BLD }} \
            -DCMAKE_PREFIX_PATH="$(brew --prefix qt@6)"
          cmake --build build

      - name: Upload x86_64 dylib (for Universal lipo step)
        uses: actions/upload-artifact@v4
        with:
          name: switchy-x86_64-dylib
          path: build/*.dylib

  # ── Universal Binary (arm64 + x86_64 via lipo) ───────────────────────────
  build-universal:
    name: macOS Universal .pkg
    runs-on: macos-14
    needs: [build-arm64, build-x86_64]
    steps:
      - uses: actions/checkout@v4

      - name: Download arm64 dylib
        uses: actions/download-artifact@v4
        with:
          name: Switchy-macos-arm64
          path: pkg-arm64

      - name: Download x86_64 dylib
        uses: actions/download-artifact@v4
        with:
          name: switchy-x86_64-dylib
          path: dylib-x86_64

      # Re-build arm64 slice for the dylib (pkg artifact has the .pkg, not .dylib)
      - name: Rebuild arm64 dylib for lipo
        run: |
          brew install qt@6
          git clone --depth 1 --branch ${{ env.OBS_VERSION }} \
            https://github.com/obsproject/obs-studio.git ${{ env.OBS_SRC }}
          cmake -S ${{ env.OBS_SRC }} -B ${{ env.OBS_BLD }} \
            -DENABLE_PLUGINS=OFF -DENABLE_UI=OFF -DENABLE_SCRIPTING=OFF \
            -DBUILD_BROWSER=OFF -DENABLE_WEBSOCKET=OFF 2>&1 | tail -3 || true
          cmake -B build_arm64 -S . -G Ninja \
            -DCMAKE_BUILD_TYPE=Release \
            -DCMAKE_OSX_ARCHITECTURES=arm64 \
            -DCMAKE_OSX_DEPLOYMENT_TARGET=12.0 \
            -DOBS_SOURCE_DIR=${{ env.OBS_SRC }} \
            -DOBS_BUILD_DIR=${{ env.OBS_BLD }} \
            -DCMAKE_PREFIX_PATH="$(brew --prefix qt@6)"
          cmake --build build_arm64

      - name: Combine with lipo → Universal dylib
        run: |
          mkdir -p universal
          ARM=$(find build_arm64     -name "*.dylib" | head -1)
          X64=$(find dylib-x86_64   -name "*.dylib" | head -1)
          echo "arm64 : $ARM"
          echo "x86_64: $X64"
          lipo -create "$ARM" "$X64" -output universal/obs-auto-cam-switcher.dylib
          lipo -info universal/obs-auto-cam-switcher.dylib

      - name: Create Universal .pkg installer
        run: |
          PLUGIN="$RUNNER_TEMP/stage/Library/Application Support/obs-studio/plugins/obs-auto-cam-switcher"
          mkdir -p "$PLUGIN/bin" "$PLUGIN/data"
          cp universal/obs-auto-cam-switcher.dylib "$PLUGIN/bin/"
          cp -r data/. "$PLUGIN/data/"
          pkgbuild \
            --root "$RUNNER_TEMP/stage" \
            --identifier com.switchy.obs-auto-cam-switcher \
            --version 1.0.0 \
            --install-location / \
            Switchy-1.0.0-macos-universal.pkg

      - name: Upload Universal .pkg
        uses: actions/upload-artifact@v4
        with:
          name: Switchy-macos-universal
          path: Switchy-1.0.0-macos-universal.pkg

  # ── Attach .pkg files to GitHub Release ──────────────────────────────────
  release-artifacts:
    name: Attach to Release
    runs-on: ubuntu-latest
    needs: [build-arm64, build-universal]
    if: github.event_name == 'release'
    steps:
      - uses: actions/download-artifact@v4
        with:
          path: installers
          merge-multiple: true
      - name: List
        run: find installers -name "*.pkg" | sort
      - uses: softprops/action-gh-release@v2
        with:
          files: installers/*.pkg
